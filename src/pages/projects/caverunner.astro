---
import BaseLayout from "../../layouts/BaseLayout.astro";

const project = {
  title: "Cave Runner (AVR Embedded Game)",
  subtitle:
    "Real-time obstacle-dodging game in C for an ATmega32U2, rendered on a 5×7 LED matrix with TinyGL score UI",
  tags: ["Engineering"],
  stackShort: ["C", "AVR (ATmega32U2)", "LED Matrix (5×7)", "Navswitch", "TinyGL", "Makefile", "dfu-programmer"],
  poster: "/images/caverunner-static.png",
  video: "/images/caverunner.mp4",
  links: [
    // { label: "Repository", href: "https://github.com/..." },
  ],
};
---

<BaseLayout title="Cave Runner">
  <header class="project-header">
    <h1>{project.title}</h1>
    <p class="project-subtitle">{project.subtitle}</p>

    <div class="tag-row">
      {project.tags.map(tag => (
        <span class={`badge badge-${tag.toLowerCase().replace(/\s+/g, "-")}`}>{tag}</span>
      ))}
    </div>

    <div class="tag-row tag-row-tech">
      {project.stackShort.map(item => (
        <span class="tag-pill">{item}</span>
      ))}
    </div>
  </header>

  {project.video && (
    <section class="project-media-block">
      <div class="project-media">
        <video
          class="project-video"
          src={project.video}
          poster={project.poster}
          muted
          loop
          playsinline
          preload="metadata"
          controls
        ></video>
      </div>
      <p class="project-caption">
        Gameplay clip recorded from the LED matrix version (poster shown before playback).
      </p>
    </section>
  )}

  <section class="project-section">
    <h2>Gameplay</h2>
    <p>
      You run through a cave and must react to incoming hazards. Each obstacle type requires a specific
      action (or set of actions) to avoid a collision. If you collide, the game ends and your score
      flashes indefinitely.
    </p>

    <h3>Obstacle rules (collision logic)</h3>
    <ul class="project-bullets">
      <li><strong>Stalactite:</strong> must <strong>crouch</strong></li>
      <li><strong>Rock:</strong> must <strong>jump</strong> or <strong>double-jump</strong></li>
      <li><strong>Bat:</strong> must <strong>crouch</strong> or <strong>double-jump</strong></li>
      <li><strong>Boulder:</strong> must <strong>double-jump</strong></li>
      <li><strong>Tunnel:</strong> must <strong>jump</strong></li>
    </ul>
  </section>

  <section class="project-section">
    <h2>Controls</h2>
    <ul class="project-bullets">
      <li><strong>Crouch:</strong> navswitch down (landscape)</li>
      <li><strong>Jump:</strong> navswitch up (landscape)</li>
      <li><strong>Double-jump:</strong> navswitch press</li>
      <li><strong>Pause:</strong> navswitch left (landscape)</li>
      <li><strong>Resume:</strong> navswitch right (landscape)</li>
    </ul>
  </section>

  <section class="project-section">
    <h2>Technical highlights</h2>
    <ul class="project-bullets">
      <li><strong>Deterministic real-time loop:</strong> fixed <strong>500 Hz</strong> pacer rate for predictable input polling and refresh.</li>
      <li><strong>LED matrix rendering:</strong> runner + obstacles stored as compact bitmasks and composed per-column.</li>
      <li><strong>Efficient scrolling:</strong> obstacle motion implemented via a left bit-shift on a timing divider.</li>
      <li><strong>Commitment window:</strong> input locked for a fixed duration after actions to prevent spam and stabilize feel.</li>
      <li><strong>Difficulty ramp:</strong> decreasing movement divider increases required reaction speed.</li>
      <li><strong>Score UI via TinyGL:</strong> score increments once per second; displayed on pause and game-over.</li>
    </ul>
  </section>

  <section class="project-section">
    <h2>Build & flash</h2>
    <p>
      Built with <code>avr-gcc</code> and flashed via <code>dfu-programmer</code> to an <code>ATmega32U2</code>.
    </p>
    <pre><code>make
make program</code></pre>
  </section>

  <section class="project-section">
    <h2>Play it in your browser</h2>
    <p class="project-subtitle">
      Faithful 5×7 recreation (smooth-rendered).
    </p>

    <div class="game-card">
      <canvas id="caverunner" width="520" height="320"></canvas>
    </div>

    <script type="module" src="/js/caverunner.js"></script>
  </section>

  {project.links?.length > 0 && (
    <section class="project-section">
      <h2>Links</h2>
      <ul class="project-bullets">
        {project.links.map(l => (
          <li><a href={l.href} target="_blank" rel="noreferrer">{l.label}</a></li>
        ))}
      </ul>
    </section>
  )}

  <p class="back-link">
    ← <a href="/projects">Back to Projects</a>
  </p>
</BaseLayout>

<style>
  .project-media {
    border-radius: 16px;
    overflow: hidden;
  }
  .project-video {
    width: 100%;
    display: block;
  }
  .game-card {
    margin-top: 1rem;
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: rgba(255, 255, 255, 0.02);
  }
  canvas#caverunner {
    width: 100%;
    height: auto;
    display: block;
    background: rgba(0, 0, 0, 0.06);
  }
</style>
